@model List<UspeshnyiTrader.Models.Entities.Instrument>
@{
    ViewData["Title"] = "Trading Instruments";
}

<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Trading Instruments</h1>
                <div>
                    <button id="updatePricesBtn" class="btn btn-outline-primary me-2">
                        <i class="fas fa-sync-alt"></i> Update Prices
                    </button>
                    <button id="simulateChangeBtn" class="btn btn-outline-success">
                        <i class="fas fa-chart-line"></i> Simulate Change
                    </button>
                </div>
            </div>
            <p class="text-muted">Real-time prices for all available trading instruments</p>
        </div>
    </div>

    <!-- Success Story Banner -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="/images/success-story.jpg" alt="–£—Å–ø–µ—à–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä"
                             class="img-fluid rounded-start" style="height: 200px; width: 100%; object-fit: cover;">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h3 class="card-title">üéØ –ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞</h3>
                            <p class="card-text">–ù–∞—à–∏ —Ç—Ä–µ–π–¥–µ—Ä—ã –¥–æ—Å—Ç–∏–≥–∞—é—Ç –≤—ã–¥–∞—é—â–∏—Ö—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é —ç—Ç–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —É—Å–ø–µ—à–Ω—ã–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º!</p>
                            <a href="@Url.Action("About", "Company")" class="btn btn-light">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Available Instruments</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="instrumentsTable">
                            <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th>Current Price</th>
                                <th>Last Update</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var instrument in Model)
                            {
                                <tr id="instrument-@instrument.Id">
                                    <td>
                                        <strong class="fs-5">@instrument.Symbol</strong>
                                    </td>
                                    <td>@instrument.Name</td>
                                    <td>
                                            <span class="price-ticker fw-bold fs-5" id="price-@instrument.Id">
                                                $@instrument.CurrentPrice.ToString("F4")
                                            </span>
                                    </td>
                                    <td>
                                        <small class="text-muted" id="update-@instrument.Id">
                                            @(instrument.LastPriceUpdate?.ToString("HH:mm:ss") ?? "Never")                                        </small>
                                    </td>
                                    <td>
                                        @if (instrument.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Index", "Trading")"
                                           class="btn btn-sm btn-primary"
                                           data-bs-toggle="tooltip"
                                           title="Trade this instrument">
                                            <i class="fas fa-chart-line"></i> Trade
                                        </a>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Instruments</h6>
                            <h3 id="totalInstruments">@Model.Count</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Instruments</h6>
                            <h3 id="activeInstruments">@Model.Count(i => i.IsActive)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Last Update</h6>
                            <h6 id="lastUpdateTime">@DateTime.Now.ToString("HH:mm:ss")</h6>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Price Updates</h6>
                            <h3 id="updateCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-sync-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let updateCount = 0;

        $(document).ready(function() {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            // Start price updates
            startPriceUpdates();

            // Update prices button
            $('#updatePricesBtn').click(function() {
                updateAllPrices();
            });

            // Simulate price change button
            $('#simulateChangeBtn').click(function() {
                simulatePriceChange();
            });
        });

        function startPriceUpdates() {
            // Update prices every 3 seconds
            setInterval(updateAllPrices, 3000);
        }

        function updateAllPrices() {
            $.get('/Instruments/GetPrices', function(prices) {
                updateCount++;
                $('#updateCount').text(updateCount);
                $('#lastUpdateTime').text(new Date().toLocaleTimeString());

                for (const instrumentId in prices) {
                    const newPrice = prices[instrumentId];
                    const priceElement = $(`#price-${instrumentId}`);
                    const oldPrice = parseFloat(priceElement.text().replace('$', ''));

                    priceElement.text(formatCurrency(newPrice));
                    $(`#update-${instrumentId}`).text(new Date().toLocaleTimeString());

                    // Add visual feedback for price changes
                    if (oldPrice && oldPrice !== newPrice) {
                        const changeClass = newPrice > oldPrice ? 'price-up' : 'price-down';
                        priceElement.addClass(changeClass + ' price-update');

                        setTimeout(() => {
                            priceElement.removeClass(changeClass + ' price-update');
                        }, 1000);
                    }
                }
            }).fail(function() {
                console.error('Failed to update prices');
            });
        }

        function simulatePriceChange() {
            const button = $('#simulateChangeBtn');
            setButtonLoading(button, true);

            $.post('/Instruments/SimulatePriceChange', function(response) {
                if (response.success) {
                    showAlert('Price changes simulated successfully', 'success');
                    updateAllPrices(); // Refresh prices
                } else {
                    showAlert('Failed to simulate price changes', 'danger');
                }
            }).fail(function() {
                showAlert('Failed to simulate price changes', 'danger');
            }).always(function() {
                setButtonLoading(button, false);
            });
        }

        // Auto-initialize instruments if empty
        $(document).ready(function() {
            if ($('#instrumentsTable tbody tr').length === 0) {
                $.post('/Instruments/InitializeInstruments', function(response) {
                    if (response.success) {
                        location.reload(); // Reload to show new instruments
                    }
                });
            }
        });
    </script>
}